<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Simulateur Voiture ‚Äì Mode manuel (capture panneau)</title>
  <style>
    :root {
      --bg1: #667eea; /* indigo */
      --bg2: #764ba2; /* purple */
      --panel: rgba(255, 255, 255, 0.95);
      --glass: rgba(255, 255, 255, 0.12);
      --text: #2d3748;
      --muted: #718096;
      --brand: #6b46c1;
      --accent: #3182ce;
      --ok: #10b981;
      --warn: #f59e0b;
      --err: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
      color: var(--text);
    }

    /* header */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px; gap: 12px;
      background: var(--glass); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.18);
    }
    .header h1 { color: #fff; font-weight: 500; font-size: 1.4rem; letter-spacing: .2px; }
    .nav-tabs { display:flex; gap:.6rem; }
    .nav-tab { text-decoration:none; color:#fff; background: rgba(255,255,255,.22); padding:.5rem .9rem; border-radius: 999px; transition:.2s; }
    .nav-tab:hover, .nav-tab.active { background: rgba(255,255,255,.3); transform: translateY(-1px); }

    /* layout */
    .layout {
      display: grid;
      grid-template-columns: 260px 1fr 320px; /* left | center | right */
      gap: 14px; padding: 14px; height: calc(100vh - 64px);
    }

    .panel { background: var(--panel); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.12); backdrop-filter: blur(10px); }

    /* left info */
    .left { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .left h3 { text-align:center; color:#4a5568; font-weight: 600; margin-bottom: 6px; }
    .info {
      background: rgba(116, 75, 162, 0.08);
      border-left: 4px solid var(--brand);
      padding: 12px 12px; border-radius: 12px;
    }
    .label { font-size: .78rem; color: var(--muted); letter-spacing:.3px; text-transform: uppercase; }
    .value { margin-top: 6px; font-size: 1.05rem; font-weight: 600; color: var(--text); min-height: 1.4em; }

    /* center screen */
    .screen { position: relative; overflow: hidden; }
    .screen video, .screen img { width: 100%; height: 100%; object-fit: cover; border-radius: 16px; display:block; }
    .shine:before {
      content: ""; position: absolute; inset: 0; pointer-events: none;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,.10) 50%, transparent 70%);
      animation: shine 3s linear infinite; border-radius: 16px;
    }
    @keyframes shine { 0%{ transform: translateX(-100%);} 100%{ transform: translateX(100%);} }

    /* right controls */
    .right { padding: 16px; display:flex; flex-direction: column; gap: 16px; align-items:center; }
    .right h3 { color:#4a5568; font-weight: 600; }

    .quick-actions { display:flex; gap:18px; flex-wrap: wrap; justify-content:center; }
    .quick { display:flex; flex-direction: column; align-items: center; gap:6px; }
    .icon-btn {
      width:64px; height:64px; border-radius: 50%; border:none; cursor:pointer; background:linear-gradient(135deg, #f6ad55, #ed8936); color:#fff; font-size:28px; box-shadow: 0 8px 18px rgba(0,0,0,.18); transition: transform .08s ease, filter .2s ease, opacity .2s; display:grid; place-items:center;
    }
    .icon-btn.secondary { background: linear-gradient(135deg, #9f7aea, #7c3aed); }
    .icon-btn.tertiary { background: linear-gradient(135deg, #34d399, #059669); }
    .icon-btn[disabled]{ opacity:.6; cursor:not-allowed; filter: grayscale(.2); }
    .icon-btn:active { transform: scale(.96); }
    .quick small { font-size: .78rem; color: var(--muted); }

    /* joystick */
    .joystick-wrap { width: 220px; height: 220px; position: relative; }
    .joystick {
      position: relative; width:100%; height:100%;
      background: radial-gradient(circle at 30% 30%, #f7fafc, #e2e8f0);
      border-radius: 50%; box-shadow: inset 0 6px 12px rgba(0,0,0,.12), 0 12px 24px rgba(0,0,0,.15);
    }
    .dpad-btn {
      position: absolute; width: 64px; height: 64px; border-radius: 16px; border:none; cursor:pointer; font-size: 22px; color:#fff; background: linear-gradient(135deg, #4299e1, var(--accent));
      display:grid; place-items:center; box-shadow: 0 10px 20px rgba(0,0,0,.18); transition: transform .06s ease;
    }
    .dpad-btn:active { transform: translateY(1px) scale(.98); }
    .dpad-up    { top: 10px; left: 50%; transform: translateX(-50%); }
    .dpad-down  { bottom: 10px; left: 50%; transform: translateX(-50%); }
    .dpad-left  { left: 10px; top: 50%; transform: translateY(-50%); }
    .dpad-right { right: 10px; top: 50%; transform: translateY(-50%); }

    .hint { font-size:.8rem; color: var(--muted); text-align:center; margin-top:4px; }

    /* toast */
    .toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
      background: var(--panel); border-radius: 999px; padding: 10px 16px; box-shadow: 0 10px 30px rgba(0,0,0,.18); display:none; align-items:center; gap:8px; }

    /* speed-limit flash */
    .flash { animation: pulse .8s ease; }
    @keyframes pulse { 0%{ box-shadow: 0 0 0 0 rgba(16,185,129,.6);} 100%{ box-shadow: 0 0 0 22px rgba(16,185,129,0);} }

    @media (max-width: 1024px){
      .layout { grid-template-columns: 1fr; height: auto; }
      .right, .left { align-items: stretch; }
      .right { order: 3; }
      .left { order: 2; }
      .screen { order: 1; height: 55vh; }
      .joystick-wrap { margin: 0 auto; }
    }

    /* === Mobile layout overrides ======================================= */
    @media (max-width: 1024px){
      .right { order: 2; }
      .left  { order: 3; }

      .left {
        display: flex; flex-direction: row; align-items: center;
        gap: 10px; padding: 10px 12px; overflow:auto; -webkit-overflow-scrolling: touch;
      }
      .left h3 { display: none; }
      .left .info { display: inline-flex; align-items: baseline; gap: 6px; background: transparent; border: none; padding: 6px 10px; border-radius: 999px; white-space: nowrap; }
      .left .label { font-size: .75rem; letter-spacing: .3px; text-transform: uppercase; color: var(--muted); }
      .left .value { font-size: .95rem; font-weight: 700; color: var(--text); margin-top: 0; min-height: auto; }

      .screen { aspect-ratio: 16/9; max-height: 58dvh; height: auto; overflow:hidden; background:#000; }
      .screen video, .screen img { width: 100%; height: 100%; object-fit: contain; border-radius: 16px; display:block; }

      .right { padding: 12px; }
      .quick-actions { gap: 12px; }
      .icon-btn { width: 56px; height: 56px; font-size: 24px; }
      .joystick-wrap { width: 200px; height: 200px; margin: 8px auto 0; }
      .dpad-btn { width: 56px; height: 56px; }

      .toast { left: 50%; transform: translateX(-50%); bottom: max(12px, env(safe-area-inset-bottom, 0px) + 12px); max-width: calc(100vw - 24px); }

      .layout { padding: max(12px, env(safe-area-inset-top, 0px)) 12px max(12px, env(safe-area-inset-bottom, 0px)) 12px; }
      .shine:before { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üöó Drive Simulator Pro</h1>
    <nav class="nav-tabs">
      <a class="nav-tab active" href="/">Simulateur</a>
      <a class="nav-tab" href="/chatbot">Chatbot</a>
    </nav>
  </div>

  <main class="layout">
    <!-- Left infos -->
    <aside class="panel left">
      <h3>‚ÑπÔ∏è Informations</h3>
      <section class="info">
        <div class="label">Vitesse Limite</div>
        <div class="value" id="speed-limit">‚Äî</div>
      </section>
      <section class="info">
        <div class="label">√âtat du moteur</div>
        <div class="value" id="engine-status">üü¢ Arr√™t√©</div>
      </section>
      <section class="info">
        <div class="label">Derni√®re commande</div>
        <div class="value" id="last-command">Aucune</div>
      </section>
    </aside>

    <!-- Center screen -->
    <section class="panel screen shine" id="screen">
      <img src="/video_feed" alt="Flux vid√©o" />
      <div style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,.45); color:#fff; padding:6px 10px; border-radius:999px; font-size:.85rem;">
        Mode d√©tection: <strong>manuel</strong>
      </div>
    </section>

    <!-- Right controls -->
    <aside class="panel right">
      <h3>üéÆ Commandes</h3>

      <div class="quick-actions" aria-label="Actions rapides">
        <div class="quick">
          <button class="icon-btn" title="Klaxonner" aria-label="Klaxonner" onclick="sendAction('klaxonne')">üîä</button>
          <small>Klaxonner</small>
        </div>
        <div class="quick">
          <button class="icon-btn secondary" title="Clignoter" aria-label="Clignoter" onclick="sendAction('clignotte')">üö®</button>
          <small>Clignoter</small>
        </div>
        <div class="quick">
          <button class="icon-btn tertiary" id="btn-capture" title="Prendre photo panneau" aria-label="Prendre photo panneau" onclick="captureSpeedSign()">üì∏</button>
          <small>Photo panneau</small>
        </div>
      </div>

      <div class="joystick-wrap" aria-label="Manette directionnelle">
        <div class="joystick">
          <button class="dpad-btn dpad-up"    title="Avancer" aria-label="Avancer" onclick="sendAction('avance')">‚¨ÜÔ∏è</button>
          <button class="dpad-btn dpad-left"  title="Tourner √† gauche" aria-label="Tourner √† gauche" onclick="sendAction('tourne_a_gauche')">‚¨ÖÔ∏è</button>
          <button class="dpad-btn dpad-right" title="Tourner √† droite" aria-label="Tourner √† droite" onclick="sendAction('tourne_a_droite')">‚û°Ô∏è</button>
          <button class="dpad-btn dpad-down"  title="Reculer" aria-label="Reculer" onclick="sendAction('recule')">‚¨áÔ∏è</button>
        </div>
      </div>
      <p class="hint">Astuce¬†: utilisez aussi les touches fl√©ch√©es du clavier.</p>
    </aside>
  </main>

  <div class="toast" id="toast">‚úÖ <span id="toast-text"></span></div>

  <script>
    // --- State --------------------------------------------------------------
    const lastCmdKey = 'simu:last-command';

    function setLastCommand(cmd){
      const map = {
        'avance': 'Avancer',
        'recule': 'Reculer',
        'tourne_a_gauche': 'Tourner √† gauche',
        'tourne_a_droite': 'Tourner √† droite',
        'klaxonne': 'Klaxonner',
        'clignotte': 'Clignoter',
        'vitesse': '√âvaluer Vitesse',
        'performance': '√âvaluer Performance',
        'capture': 'Capture panneau'
      };
      const label = map[cmd] || cmd;
      document.getElementById('last-command').textContent = label;
      try { localStorage.setItem(lastCmdKey, label); } catch(_){}
      showToast(`Derni√®re commande¬†: ${label}`);
    }

    function showToast(text, ok=true){
      const toast = document.getElementById('toast');
      const tt = document.getElementById('toast-text');
      tt.textContent = text;
      toast.style.display = 'flex';
      toast.style.border = `1px solid ${ok ? 'rgba(16,185,129,.35)' : 'rgba(239,68,68,.35)'}`;
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ toast.style.display='none'; }, 1800);
    }

    // Load persisted last command on startup
    (function(){
      try {
        const saved = localStorage.getItem(lastCmdKey);
        if(saved){ document.getElementById('last-command').textContent = saved; }
      } catch(_){ /* ignore */ }
    })();

    // --- Backend interaction (movement) ------------------------------------
    function sendAction(action){
      fetch('/simulate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action })
      })
      .then(r => r.json())
      .then(data => {
        flashOverlay(action);
        setLastCommand(data.action || action);
      })
      .catch(err => {
        console.error('Erreur:', err);
        flashOverlay('Erreur');
      });
    }

    // Visual micro‚Äëfeedback on the screen
    function flashOverlay(action){
      const messages = {
        'avance': 'Avance‚Ä¶',
        'recule': 'Recule‚Ä¶',
        'tourne_a_gauche': 'Gauche‚Ä¶',
        'tourne_a_droite': 'Droite‚Ä¶',
        'klaxonne': 'BEEP! Klaxon',
        'clignotte': 'Clignotants',
        'capture': 'Capture‚Ä¶',
        'Erreur': 'Erreur'
      };
      const scr = document.getElementById('screen');
      const tag = document.createElement('div');
      tag.style.position = 'absolute';
      tag.style.inset = '0';
      tag.style.display = 'grid';
      tag.style.placeItems = 'center';
      tag.style.pointerEvents = 'none';
      tag.style.borderRadius = '16px';
      tag.style.backdropFilter = 'blur(2px)';
      tag.style.background = 'rgba(0,0,0,.18)';
      tag.style.color = '#fff';
      tag.style.fontSize = '1.4rem';
      tag.textContent = messages[action] || action;
      scr.appendChild(tag);
      setTimeout(()=>{ tag.remove(); }, 500);
    }

    // Keyboard support for arrows
    window.addEventListener('keydown', (e)=>{
      if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        const map = { ArrowUp:'avance', ArrowDown:'recule', ArrowLeft:'tourne_a_gauche', ArrowRight:'tourne_a_droite' };
        sendAction(map[e.key]);
      }
      if(e.key === 'c' || e.key === 'C'){ captureSpeedSign(); }
    });

    // --- Rafra√Æchit l'affichage de la vitesse limite depuis /speed_limit ---
    async function refreshSpeedLimit(){
      try{
        const r = await fetch('/speed_limit');
        const j = await r.json();
        const el = document.getElementById('speed-limit');
        const v = j && j.speed_limit;
        if(v === null || v === undefined){
          el.textContent = '‚Äî';
        }else{
          const txt = Number.isInteger(v) ? `${v} km/h` : `${(+v).toFixed(1)} km/h`;
          el.textContent = txt;
        }
      }catch(e){ /* silencieux */ }
    }
    refreshSpeedLimit();
    setInterval(refreshSpeedLimit, 1000);

    // --- NOUVEAU : capture manuelle du panneau + OCR -----------------------
    async function captureSpeedSign(){
      const btn = document.getElementById('btn-capture');
      if(btn.hasAttribute('disabled')) return;
      setLastCommand('capture');
      flashOverlay('capture');
      const original = btn.textContent;
      btn.setAttribute('disabled', '');
      btn.textContent = '‚è≥';
      try {
        const r = await fetch('/capture_speed_sign', { method:'POST' });
        const j = await r.json();
        if(!j.ok){
          showToast(j.error ? `Erreur capture: ${j.error}` : '√âchec capture', false);
          return;
        }
        // Forcer rafra√Æchissement vitesse c√¥t√© UI
        await refreshSpeedLimit();
        if(j.detected != null){
          const v = Number(j.detected);
          showToast(`Limite d√©tect√©e: ${v} km/h`);
          highlightSpeedLimit();
        }else{
          showToast('Aucun nombre d√©tect√©', false);
        }
      }catch(e){
        console.error(e);
        showToast('Erreur r√©seau', false);
      }finally{
        btn.removeAttribute('disabled');
        btn.textContent = original;
      }
    }

    function highlightSpeedLimit(){
      const el = document.getElementById('speed-limit');
      el.classList.add('flash');
      setTimeout(()=> el.classList.remove('flash'), 900);
    }
  </script>
</body>
</html>