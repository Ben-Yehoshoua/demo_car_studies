<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Simulateur Voiture ‚Äì Mode manuel (capture panneau)</title>
  <style>
    :root {
      --bg1: #667eea; /* indigo */
      --bg2: #764ba2; /* purple */
      --panel: rgba(255, 255, 255, 0.95);
      --glass: rgba(255, 255, 255, 0.12);
      --text: #2d3748;
      --muted: #718096;
      --brand: #6b46c1;
      --accent: #3182ce;
      --ok: #10b981;
      --warn: #f59e0b;
      --err: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
      color: var(--text);
    }

    /* header */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px; gap: 12px;
      background: var(--glass); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.18);
    }
    .header h1 { color: #fff; font-weight: 500; font-size: 1.4rem; letter-spacing: .2px; }
    .nav-tabs { display:flex; gap:.6rem; }
    .nav-tab { text-decoration:none; color:#fff; background: rgba(255,255,255,.22); padding:.5rem .9rem; border-radius: 999px; transition:.2s; }
    .nav-tab:hover, .nav-tab.active { background: rgba(255,255,255,.3); transform: translateY(-1px); }

    /* layout */
    .layout { display: grid; grid-template-columns: 260px 1fr 320px; gap: 14px; padding: 14px; height: calc(100vh - 64px); }
    .panel { background: var(--panel); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.12); backdrop-filter: blur(10px); }

    /* left info */
    .left { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .left h3 { text-align:center; color:#4a5568; font-weight: 600; margin-bottom: 6px; }
    .info { background: rgba(116, 75, 162, 0.08); border-left: 4px solid var(--brand); padding: 12px 12px; border-radius: 12px; }
    .label { font-size: .78rem; color: var(--muted); letter-spacing:.3px; text-transform: uppercase; }
    .value { margin-top: 6px; font-size: 1.05rem; font-weight: 600; color: var(--text); min-height: 1.4em; }

    /* center screen */
    .screen { position: relative; overflow: hidden; }
    .screen video, .screen img { width: 100%; height: 100%; object-fit: cover; border-radius: 16px; display:block; }
    .shine:before { content: ""; position: absolute; inset: 0; pointer-events: none; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,.10) 50%, transparent 70%); animation: shine 3s linear infinite; border-radius: 16px; }
    @keyframes shine { 0%{ transform: translateX(-100%);} 100%{ transform: translateX(100%);} }

    /* right controls */
    .right { padding: 16px; display:flex; flex-direction: column; gap: 16px; align-items:center; }
    .right h3 { color:#4a5568; font-weight: 600; }

    .quick-actions { display:flex; gap:18px; flex-wrap: wrap; justify-content:center; }
    .quick { display:flex; flex-direction: column; align-items: center; gap:6px; }
    .icon-btn { width:64px; height:64px; border-radius: 50%; border:none; cursor:pointer; background:linear-gradient(135deg, #f6ad55, #ed8936); color:#fff; font-size:28px; box-shadow: 0 8px 18px rgba(0,0,0,.18); transition: transform .08s ease, filter .2s ease, opacity .2s; display:grid; place-items:center; }
    .icon-btn.secondary { background: linear-gradient(135deg, #9f7aea, #7c3aed); }
    .icon-btn.tertiary { background: linear-gradient(135deg, #34d399, #059669); }
    .icon-btn[disabled]{ opacity:.6; cursor:not-allowed; filter: grayscale(.2); }
    .icon-btn:active { transform: scale(.96); }
    .quick small { font-size: .78rem; color: var(--muted); }

    /* controller selector */
    .controller-switch { width: 100%; max-width: 280px; background: rgba(49,130,206,.08); border-radius: 999px; padding: 6px; position: relative; display:flex; gap:6px; }
    .controller-pill { flex:1; position:relative; z-index:2; border:none; background:transparent; padding:10px 12px; border-radius:999px; cursor:pointer; font-weight:600; color:#2b6cb0; }
    .controller-pill[aria-pressed="true"] { color:#1a202c; }
    .controller-indicator { position:absolute; z-index:1; top:6px; bottom:6px; width: calc(50% - 6px); left:6px; border-radius:999px; background:#fff; box-shadow: 0 8px 20px rgba(0,0,0,.12); transition: left .25s ease; }
    .controller-switch.camera .controller-indicator { left: calc(50% + 0px); }
    .controller-hint { font-size:.8rem; color: var(--muted); text-align:center; }

    /* joystick */
    .joystick-wrap { width: 220px; height: 220px; position: relative; }
    .joystick { position: relative; width:100%; height:100%; background: radial-gradient(circle at 30% 30%, #f7fafc, #e2e8f0); border-radius: 50%; box-shadow: inset 0 6px 12px rgba(0,0,0,.12), 0 12px 24px rgba(0,0,0,.15); }
    .dpad-btn { position: absolute; width: 64px; height: 64px; border-radius: 16px; border:none; cursor:pointer; font-size: 22px; color:#fff; background: linear-gradient(135deg, #4299e1, var(--accent)); display:grid; place-items:center; box-shadow: 0 10px 20px rgba(0,0,0,.18); transition: transform .06s ease; }
    .dpad-btn:active { transform: translateY(1px) scale(.98); }
    .dpad-up    { top: 10px; left: 50%; transform: translateX(-50%); }
    .dpad-down  { bottom: 10px; left: 50%; transform: translateX(-50%); }
    .dpad-left  { left: 10px; top: 50%; transform: translateY(-50%); }
    .dpad-right { right: 10px; top: 50%; transform: translateY(-50%); }

    .hint { font-size:.8rem; color: var(--muted); text-align:center; margin-top:4px; }

    /* toast */
    .toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
      background: var(--panel); border-radius: 999px; padding: 10px 16px; box-shadow: 0 10px 30px rgba(0,0,0,.18); display:none; align-items:center; gap:8px; }

    /* speed-limit flash */
    .flash { animation: pulse .8s ease; }
    @keyframes pulse { 0%{ box-shadow: 0 0 0 0 rgba(16,185,129,.6);} 100%{ box-shadow: 0 0 0 22px rgba(16,185,129,0);} }

    @media (max-width: 1024px){
      .layout { grid-template-columns: 1fr; height: auto; }
      .right, .left { align-items: stretch; }
      .right { order: 3; }
      .left { order: 2; }
      .screen { order: 1; height: 55vh; }
      .joystick-wrap { margin: 0 auto; }
    }

    /* === Mobile layout overrides ======================================= */
    @media (max-width: 1024px){
      .right { order: 2; }
      .left  { order: 3; }

      .left { display: flex; flex-direction: row; align-items: center; gap: 10px; padding: 10px 12px; overflow:auto; -webkit-overflow-scrolling: touch; }
      .left h3 { display: none; }
      .left .info { display: inline-flex; align-items: baseline; gap: 6px; background: transparent; border: none; padding: 6px 10px; border-radius: 999px; white-space: nowrap; }
      .left .label { font-size: .75rem; letter-spacing: .3px; text-transform: uppercase; color: var(--muted); }
      .left .value { font-size: .95rem; font-weight: 700; color: var(--text); margin-top: 0; min-height: auto; }

      .screen { aspect-ratio: 16/9; max-height: 58dvh; height: auto; overflow:hidden; background:#000; }
      .screen video, .screen img { width: 100%; height: 100%; object-fit: contain; border-radius: 16px; display:block; }

      .right { padding: 12px; }
      .quick-actions { gap: 12px; }
      .icon-btn { width: 56px; height: 56px; font-size: 24px; }
      .joystick-wrap { width: 200px; height: 200px; margin: 8px auto 0; }
      .dpad-btn { width: 56px; height: 56px; }

      .toast { left: 50%; transform: translateX(-50%); bottom: max(12px, env(safe-area-inset-bottom, 0px) + 12px); max-width: calc(100vw - 24px); }

      .layout { padding: max(12px, env(safe-area-inset-top, 0px)) 12px max(12px, env(safe-area-inset-bottom, 0px)) 12px; }
      .shine:before { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üöó Drive Simulator Pro</h1>
    <nav class="nav-tabs">
      <a class="nav-tab active" href="/">Simulateur</a>
      <a class="nav-tab" href="/chatbot">Chatbot</a>
    </nav>
  </div>

  <main class="layout">
    <!-- Left infos -->
    <aside class="panel left">
      <h3>‚ÑπÔ∏è Informations</h3>
      <section class="info">
        <div class="label">Vitesse Limite</div>
        <div class="value" id="speed-limit">‚Äî</div>
      </section>
      <section class="info">
        <div class="label">√âtat du moteur</div>
        <div class="value" id="engine-status">üü¢ Arr√™t√©</div>
      </section>
      <section class="info">
        <div class="label">Derni√®re commande</div>
        <div class="value" id="last-command">Aucune</div>
      </section>
      <section class="info" aria-live="polite" aria-atomic="true">
        <div class="label">Description image</div>
        <div class="value" id="img-desc">‚Äî</div>
      </section>
    </aside>

    <!-- Center screen -->
    <section class="panel screen shine" id="screen">
      <img src="/video_feed" alt="Flux vid√©o" />
      <div style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,.45); color:#fff; padding:6px 10px; border-radius:999px; font-size:.85rem;">
        Mode d√©tection: <strong>manuel</strong>
      </div>
    </section>

    <!-- Right controls -->
    <aside class="panel right">
      <h3>üéÆ Commandes</h3>

      <div class="quick-actions" aria-label="Actions rapides">
        <div class="quick">
          <button class="icon-btn" title="Klaxonner" aria-label="Klaxonner" onclick="sendAction('klaxonne')">üîä</button>
          <small>Klaxonner</small>
        </div>
        <div class="quick">
          <button class="icon-btn secondary" title="Clignoter" aria-label="Clignoter" onclick="sendAction('clignotte')">üö®</button>
          <small>Clignoter</small>
        </div>
        <div class="quick">
          <button class="icon-btn tertiary" id="btn-capture" title="Prendre photo panneau" aria-label="Prendre photo panneau" onclick="captureSpeedSign()">üì∏</button>
          <small>Photo panneau</small>
        </div>
      </div>

      <!-- Nouveau: s√©lecteur de manette -->
      <div id="controllerSwitch" class="controller-switch" role="tablist" aria-label="S√©lecteur de manette">
        <div class="controller-indicator" aria-hidden="true"></div>
        <button id="pillVehicle" class="controller-pill" role="tab" aria-selected="true" aria-pressed="true" onclick="setController('vehicle')">üöó V√©hicule</button>
        <button id="pillCamera" class="controller-pill" role="tab" aria-selected="false" aria-pressed="false" onclick="setController('camera')">üé• Cam√©ra</button>
      </div>
      <div class="controller-hint" id="controllerHint">Fl√®ches clavier = V√©hicule ¬∑ ZQSD = Cam√©ra ¬∑ 1/2 pour switcher</div>

      <div class="joystick-wrap" aria-label="Manette directionnelle">
        <div class="joystick">
          <button class="dpad-btn dpad-up"    id="btn-up"    title="Avancer" aria-label="Avancer">‚¨ÜÔ∏è</button>
          <button class="dpad-btn dpad-left"  id="btn-left"  title="Gauche"  aria-label="Gauche">‚¨ÖÔ∏è</button>
          <button class="dpad-btn dpad-right" id="btn-right" title="Droite"  aria-label="Droite">‚û°Ô∏è</button>
          <button class="dpad-btn dpad-down"  id="btn-down"  title="Reculer" aria-label="Reculer">‚¨áÔ∏è</button>
        </div>
      </div>
      <p class="hint">Astuce¬†: touche <strong>C</strong> = Photo panneau.</p>
    </aside>
  </main>

  <div class="toast" id="toast">‚úÖ <span id="toast-text"></span></div>

  <script>
    // --- State --------------------------------------------------------------
    const lastCmdKey = 'simu:last-command';
    let currentController = 'vehicle'; // 'vehicle' | 'camera'

    function setLastCommand(cmd){
      const map = {
        'avance': 'Avancer', 'recule': 'Reculer', 'tourne_a_gauche': 'Tourner √† gauche', 'tourne_a_droite': 'Tourner √† droite',
        'klaxonne': 'Klaxonner', 'clignotte': 'Clignoter', 'vitesse': '√âvaluer Vitesse', 'performance': '√âvaluer Performance', 'capture': 'Capture panneau',
        'cam_up':'Cam√©ra ‚Üë', 'cam_down':'Cam√©ra ‚Üì', 'cam_left':'Cam√©ra ‚Üê', 'cam_right':'Cam√©ra ‚Üí'
      };
      const label = map[cmd] || cmd;
      document.getElementById('last-command').textContent = label;
      try { localStorage.setItem(lastCmdKey, label); } catch(_){ }
      showToast(`Derni√®re commande¬†: ${label}`);
    }

    function showToast(text, ok=true){
      const toast = document.getElementById('toast');
      const tt = document.getElementById('toast-text');
      tt.textContent = text;
      toast.style.display = 'flex';
      toast.style.border = `1px solid ${ok ? 'rgba(16,185,129,.35)' : 'rgba(239,68,68,.35)'}`;
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ toast.style.display='none'; }, 1800);
    }

    (function(){
      try { const saved = localStorage.getItem(lastCmdKey); if(saved){ document.getElementById('last-command').textContent = saved; } } catch(_){ }
    })();

    // --- Backend interaction ----------------------------------------------
    function sendAction(action){
      fetch('/simulate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action }) })
      .then(r => r.json())
      .then(data => { flashOverlay(action); setLastCommand(data.action || action); })
      .catch(err => { console.error('Erreur:', err); flashOverlay('Erreur'); });
    }

    function flashOverlay(action){
      const messages = {
        'avance': 'Avance‚Ä¶', 'recule': 'Recule‚Ä¶', 'tourne_a_gauche': 'Gauche‚Ä¶', 'tourne_a_droite': 'Droite‚Ä¶',
        'klaxonne': 'BEEP! Klaxon', 'clignotte': 'Clignotants', 'capture': 'Capture‚Ä¶',
        'cam_up':'Cam√©ra ‚Üë', 'cam_down':'Cam√©ra ‚Üì', 'cam_left':'Cam√©ra ‚Üê', 'cam_right':'Cam√©ra ‚Üí',
        'Erreur':'Erreur'
      };
      const scr = document.getElementById('screen');
      const tag = document.createElement('div');
      tag.style.position = 'absolute'; tag.style.inset = '0'; tag.style.display = 'grid'; tag.style.placeItems = 'center'; tag.style.pointerEvents = 'none'; tag.style.borderRadius = '16px'; tag.style.backdropFilter = 'blur(2px)'; tag.style.background = 'rgba(0,0,0,.18)'; tag.style.color = '#fff'; tag.style.fontSize = '1.4rem';
      tag.textContent = messages[action] || action;
      scr.appendChild(tag);
      setTimeout(()=>{ tag.remove(); }, 500);
    }

    // --- Controller switch -------------------------------------------------
    function setController(type){
      currentController = (type === 'camera') ? 'camera' : 'vehicle';
      const switchEl = document.getElementById('controllerSwitch');
      switchEl.classList.toggle('camera', currentController === 'camera');
      document.getElementById('pillVehicle').setAttribute('aria-pressed', currentController==='vehicle');
      document.getElementById('pillCamera').setAttribute('aria-pressed', currentController==='camera');
      document.getElementById('pillVehicle').setAttribute('aria-selected', currentController==='vehicle');
      document.getElementById('pillCamera').setAttribute('aria-selected', currentController==='camera');
      updateDpadTitles();
      const hint = (currentController==='vehicle')?
        'Fl√®ches clavier = V√©hicule ¬∑ ZQSD = Cam√©ra ¬∑ 1/2 pour switcher':
        'ZQSD = Cam√©ra ¬∑ Fl√®ches = V√©hicule ¬∑ 1/2 pour switcher';
      document.getElementById('controllerHint').textContent = hint;
    }

    function updateDpadTitles(){
      if(currentController==='vehicle'){
        document.getElementById('btn-up').title = 'Avancer';
        document.getElementById('btn-down').title = 'Reculer';
        document.getElementById('btn-left').title = 'Tourner √† gauche';
        document.getElementById('btn-right').title = 'Tourner √† droite';
      }else{
        document.getElementById('btn-up').title = 'Cam√©ra haut';
        document.getElementById('btn-down').title = 'Cam√©ra bas';
        document.getElementById('btn-left').title = 'Cam√©ra gauche';
        document.getElementById('btn-right').title = 'Cam√©ra droite';
      }
    }

    // Attach click handlers for D-pad once
    ['up','down','left','right'].forEach(dir => {
      document.getElementById(`btn-${dir}`).addEventListener('click', () => {
        if(currentController==='vehicle'){
          const map = { up:'avance', down:'recule', left:'tourne_a_gauche', right:'tourne_a_droite' };
          sendAction(map[dir]);
        } else {
          const map = { up:'cam_up', down:'cam_down', left:'cam_left', right:'cam_right' };
          sendAction(map[dir]);
        }
      });
    });

    // Keyboard support
    window.addEventListener('keydown', (e)=>{
      // quick switch
      if(e.key==='1'){ setController('vehicle'); }
      if(e.key==='2'){ setController('camera'); }

      // capture
      if(e.key==='c' || e.key==='C'){ captureSpeedSign(); }

      // arrows always control VEHICLE
      if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        const map = { ArrowUp:'avance', ArrowDown:'recule', ArrowLeft:'tourne_a_gauche', ArrowRight:'tourne_a_droite' };
        sendAction(map[e.key]);
      }

      // ZQSD (AZERTY) always control CAMERA
      const k = e.key.toLowerCase();
      if(['z','q','s','d'].includes(k)){
        e.preventDefault();
        const map = { z:'cam_up', s:'cam_down', q:'cam_left', d:'cam_right' };
        sendAction(map[k]);
      }
    });

    // --- Speed limit polling ----------------------------------------------
    async function refreshSpeedLimit(){
      try{
        const r = await fetch('/speed_limit');
        const j = await r.json();
        const el = document.getElementById('speed-limit');
        const v = j && j.speed_limit;
        if(v === null || v === undefined){ el.textContent = '‚Äî'; }
        else { el.textContent = (Number.isInteger(v) ? `${v} km/h` : `${(+v).toFixed(1)} km/h`); }
      }catch(e){ /* silencieux */ }
    }
    refreshSpeedLimit();
    setInterval(refreshSpeedLimit, 1000);

    // --- Description IA helpers -------------------------------------------
    function setImageDescription(text){ document.getElementById('img-desc').textContent = text || '‚Äî'; }
    function limitToFiveWords(text){ if(!text) return '‚Äî'; return text.toString().trim().split(/\s+/).filter(Boolean).slice(0,5).join(' '); }
    async function describeImage(savedPath){
      if(!savedPath){ setImageDescription('‚Äî'); return; }
      setImageDescription('Analyse en cours‚Ä¶');
      try{
        const r = await fetch('/describe_image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: savedPath }) });
        const j = await r.json();
        const raw = (j && (j.description || j.desc || j.text || '')).toString();
        setImageDescription(limitToFiveWords(raw));
      }catch(e){ console.error(e); setImageDescription('Erreur description'); }
    }

    // --- Capture + OCR -----------------------------------------------------
    async function captureSpeedSign(){
      const btn = document.getElementById('btn-capture');
      if(btn.hasAttribute('disabled')) return;
      setLastCommand('capture'); flashOverlay('capture');
      const original = btn.textContent; btn.setAttribute('disabled',''); btn.textContent='‚è≥';
      try {
        const r = await fetch('/capture_speed_sign', { method:'POST' });
        const j = await r.json();
        if(!j.ok){ showToast(j.error ? `Erreur capture: ${j.error}` : '√âchec capture', false); setImageDescription('‚Äî'); return; }
        await refreshSpeedLimit();
        if(j.detected != null){ const v = Number(j.detected); showToast(`Limite d√©tect√©e: ${v} km/h`); highlightSpeedLimit(); }
        else{ showToast('Aucun nombre d√©tect√©', false); }
        if(j.saved_path){ await describeImage(j.saved_path); }
      }catch(e){ console.error(e); showToast('Erreur r√©seau', false); setImageDescription('Erreur description'); }
      finally{ btn.removeAttribute('disabled'); btn.textContent = original; }
    }

    function highlightSpeedLimit(){ const el = document.getElementById('speed-limit'); el.classList.add('flash'); setTimeout(()=> el.classList.remove('flash'), 900); }

    // init
    setController('vehicle');
  </script>
</body>
</html>