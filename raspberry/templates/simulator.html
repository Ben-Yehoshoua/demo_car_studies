<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Simulateur Voiture ‚Äì Nouvelle UI</title>
  <style>
    :root {
      --bg1: #667eea; /* indigo */
      --bg2: #764ba2; /* purple */
      --panel: rgba(255, 255, 255, 0.95);
      --glass: rgba(255, 255, 255, 0.12);
      --text: #2d3748;
      --muted: #718096;
      --brand: #6b46c1;
      --accent: #3182ce;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
      color: var(--text);
    }

    /* header */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px; gap: 12px;
      background: var(--glass); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.18);
    }
    .header h1 { color: #fff; font-weight: 500; font-size: 1.4rem; letter-spacing: .2px; }
    .nav-tabs { display:flex; gap:.6rem; }
    .nav-tab { text-decoration:none; color:#fff; background: rgba(255,255,255,.22); padding:.5rem .9rem; border-radius: 999px; transition:.2s; }
    .nav-tab:hover, .nav-tab.active { background: rgba(255,255,255,.3); transform: translateY(-1px); }

    /* layout */
    .layout {
      display: grid;
      grid-template-columns: 260px 1fr 320px; /* left | center | right */
      gap: 14px; padding: 14px; height: calc(100vh - 64px);
    }

    .panel { background: var(--panel); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.12); backdrop-filter: blur(10px); }

    /* left info */
    .left { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .left h3 { text-align:center; color:#4a5568; font-weight: 600; margin-bottom: 6px; }
    .info {
      background: rgba(116, 75, 162, 0.08);
      border-left: 4px solid var(--brand);
      padding: 12px 12px; border-radius: 12px;
    }
    .label { font-size: .78rem; color: var(--muted); letter-spacing:.3px; text-transform: uppercase; }
    .value { margin-top: 6px; font-size: 1.05rem; font-weight: 600; color: var(--text); min-height: 1.4em; }

    /* center screen */
    .screen { position: relative; overflow: hidden; }
    .screen video, .screen img { width: 100%; height: 100%; object-fit: cover; border-radius: 16px; display:block; }
    .shine:before {
      content: ""; position: absolute; inset: 0; pointer-events: none;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,.10) 50%, transparent 70%);
      animation: shine 3s linear infinite; border-radius: 16px;
    }
    @keyframes shine { 0%{ transform: translateX(-100%);} 100%{ transform: translateX(100%);} }

    /* right controls */
    .right { padding: 16px; display:flex; flex-direction: column; gap: 16px; align-items:center; }
    .right h3 { color:#4a5568; font-weight: 600; }

    .quick-actions { display:flex; gap:18px; }
    .quick { display:flex; flex-direction: column; align-items: center; gap:6px; }
    .icon-btn {
      width:64px; height:64px; border-radius: 50%; border:none; cursor:pointer; background:linear-gradient(135deg, #f6ad55, #ed8936); color:#fff; font-size:28px; box-shadow: 0 8px 18px rgba(0,0,0,.18); transition: transform .08s ease; display:grid; place-items:center;
    }
    .icon-btn.secondary { background: linear-gradient(135deg, #9f7aea, #7c3aed); }
    .icon-btn:active { transform: scale(.96); }
    .quick small { font-size: .78rem; color: var(--muted); }

    /* joystick */
    .joystick-wrap { width: 220px; height: 220px; position: relative; }
    .joystick {
      position: relative; width:100%; height:100%;
      background: radial-gradient(circle at 30% 30%, #f7fafc, #e2e8f0);
      border-radius: 50%; box-shadow: inset 0 6px 12px rgba(0,0,0,.12), 0 12px 24px rgba(0,0,0,.15);
    }
    .dpad-btn {
      position: absolute; width: 64px; height: 64px; border-radius: 16px; border:none; cursor:pointer; font-size: 22px; color:#fff; background: linear-gradient(135deg, #4299e1, var(--accent));
      display:grid; place-items:center; box-shadow: 0 10px 20px rgba(0,0,0,.18); transition: transform .06s ease;
    }
    .dpad-btn:active { transform: translateY(1px) scale(.98); }
    .dpad-up    { top: 10px; left: 50%; transform: translateX(-50%); }
    .dpad-down  { bottom: 10px; left: 50%; transform: translateX(-50%); }
    .dpad-left  { left: 10px; top: 50%; transform: translateY(-50%); }
    .dpad-right { right: 10px; top: 50%; transform: translateY(-50%); }

    .hint { font-size:.8rem; color: var(--muted); text-align:center; margin-top:4px; }

    /* toast last command */
    .toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
      background: var(--panel); border-radius: 999px; padding: 10px 16px; box-shadow: 0 10px 30px rgba(0,0,0,.18); display:none; align-items:center; gap:8px; }

    @media (max-width: 1024px){
      .layout { grid-template-columns: 1fr; height: auto; }
      .right, .left { align-items: stretch; }
      .right { order: 3; }
      .left { order: 2; }
      .screen { order: 1; height: 55vh; }
      .joystick-wrap { margin: 0 auto; }
    }
  
/* === Mobile layout overrides (requested) ================================ */
@media (max-width: 1024px){
  /* Stack vertically: Screen ‚Üí Manettes ‚Üí Infos (single line) */
  .right { order: 2; }        /* controls */
  .left  { order: 3; }        /* info row */

  /* Make the info panel a single horizontal bar */
  .left {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
  }
  .left h3 { display: none; } /* hide "Informations" title to keep a single line */

  /* Each info block becomes a compact chip */
  .left .info {
    display: inline-flex;
    align-items: baseline;
    gap: 6px;
    background: transparent;
    border: none;
    padding: 6px 10px;
    border-radius: 999px;
    white-space: nowrap; /* keep on one line */
  }
  .left .label {
    font-size: .75rem;
    letter-spacing: .3px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .left .value {
    font-size: .95rem;
    font-weight: 700;
    color: var(--text);
    margin-top: 0;
    min-height: auto;
  }

  /* Ensure the joystick stays centered on mobile */
  .joystick-wrap { margin: 8px auto 0; }

  /* Keep the camera tall on mobile */
  .screen { height: 55vh; }
}

/* --- Contrainte cam√©ra & mise √† l'√©chelle sur mobile --- */
@media (max-width: 1024px){
  /* Le panneau √©cran ne d√©passe jamais le viewport */
  .screen {
    /* garde un ratio confortable, tout en restant dans la hauteur visible */
    aspect-ratio: 16 / 9;
    max-height: 58dvh;           /* √©vite le d√©bordement sur claviers/OS bars */
    height: auto;                /* laisse le ratio contr√¥ler la hauteur */
    overflow: hidden;            /* coupe tout d√©bordement √©ventuel */
    background: #000;            /* bandes noires si besoin */
  }
  /* Le flux vid√©o est contenu (pas recadr√©) */
  .screen video,
  .screen img {
    width: 100%;
    height: 100%;
    object-fit: contain;         /* <= le point cl√©: plus de d√©passement */
    border-radius: 16px;
    display: block;
  }

  /* Palette commandes: compacte & wrap si manque de place */
  .right { padding: 12px; }
  .quick-actions { 
    gap: 12px; 
    flex-wrap: wrap;             /* passe √† la ligne si n√©cessaire */
    justify-content: center;
  }
  .icon-btn { 
    width: 56px; 
    height: 56px; 
    font-size: 24px; 
  }
  .joystick-wrap { 
    width: 200px; 
    height: 200px; 
    margin: 8px auto 0; 
  }
  .dpad-btn { width: 56px; height: 56px; }

  /* Panneau infos en bas: reste sur une seule ligne et ne pousse rien hors √©cran */
  .left {
    padding: 8px 10px;
    overflow: auto;              /* scroll horizontal si vraiment trop long */
    -webkit-overflow-scrolling: touch;
  }

  /* Toast (bandeau du bas): respecte la zone s√ªre et ne sort pas de l'√©cran */
  .toast {
    left: 50%;
    transform: translateX(-50%);
    bottom: max(12px, env(safe-area-inset-bottom, 0px) + 12px);
    max-width: calc(100vw - 24px);
  }

  /* Le layout prend en compte la zone s√ªre globale */
  .layout {
    padding:
      max(12px, env(safe-area-inset-top, 0px))
      12px
      max(12px, env(safe-area-inset-bottom, 0px))
      12px;
  }
}

/* Optionnel: limiter la brillance sur mobile pour √©viter l'effet "bord qui d√©passe" */
@media (max-width: 1024px){
  .shine:before { display: none; }
}

/* ======================================================================= */

</style>
</head>
<body>
  <div class="header">
    <h1>üöó Drive Simulator Pro</h1>
    <nav class="nav-tabs">
      <a class="nav-tab active" href="/">Simulateur</a>
      <a class="nav-tab" href="/chatbot">Chatbot</a>
    </nav>
  </div>

  <main class="layout">
    <!-- Left infos only: Vitesse Limite, Etat du moteur, Derni√®re commande -->
    <aside class="panel left">
      <h3>‚ÑπÔ∏è Informations</h3>
      <section class="info">
        <div class="label">Vitesse Limite</div>
        <div class="value" id="speed-limit">‚Äî</div>
      </section>
      <section class="info">
        <div class="label">√âtat du moteur</div>
        <div class="value" id="engine-status">üü¢ Arr√™t√©</div>
      </section>
      <section class="info">
        <div class="label">Derni√®re commande</div>
        <div class="value" id="last-command">Aucune</div>
      </section>
    </aside>

    <!-- Center screen (unchanged backend: still uses /video_feed) -->
    <section class="panel screen shine" id="screen">
      <img src="/video_feed" alt="Flux vid√©o" />
    </section>

    <!-- Right controls: icons on top + joystick style for directions -->
    <aside class="panel right">
      <h3>üéÆ Commandes</h3>

      <div class="quick-actions" aria-label="Actions rapides">
        <div class="quick">
          <button class="icon-btn" title="Klaxonner" aria-label="Klaxonner" onclick="sendAction('klaxonne')">üîä</button>
          <small>Klaxonner</small>
        </div>
        <div class="quick">
          <button class="icon-btn secondary" title="Clignoter" aria-label="Clignoter" onclick="sendAction('clignotte')">üö®</button>
          <small>Clignoter</small>
        </div>
      </div>

      <div class="joystick-wrap" aria-label="Manette directionnelle">
        <div class="joystick">
          <button class="dpad-btn dpad-up"    title="Avancer" aria-label="Avancer" onclick="sendAction('avance')">‚¨ÜÔ∏è</button>
          <button class="dpad-btn dpad-left"  title="Tourner √† gauche" aria-label="Tourner √† gauche" onclick="sendAction('tourne_a_gauche')">‚¨ÖÔ∏è</button>
          <button class="dpad-btn dpad-right" title="Tourner √† droite" aria-label="Tourner √† droite" onclick="sendAction('tourne_a_droite')">‚û°Ô∏è</button>
          <button class="dpad-btn dpad-down"  title="Reculer" aria-label="Reculer" onclick="sendAction('recule')">‚¨áÔ∏è</button>
        </div>
      </div>
      <p class="hint">Astuce¬†: utilisez aussi les touches fl√©ch√©es du clavier.</p>
    </aside>
  </main>

  <div class="toast" id="toast">‚úÖ <span id="toast-text"></span></div>

  <script>
    // --- State --------------------------------------------------------------
    const lastCmdKey = 'simu:last-command';

    function setLastCommand(cmd){
      const map = {
        'avance': 'Avancer',
        'recule': 'Reculer',
        'tourne_a_gauche': 'Tourner √† gauche',
        'tourne_a_droite': 'Tourner √† droite',
        'klaxonne': 'Klaxonner',
        'clignotte': 'Clignoter',
        'vitesse': '√âvaluer Vitesse',
        'performance': '√âvaluer Performance'
      };
      const label = map[cmd] || cmd;
      document.getElementById('last-command').textContent = label;
      try { localStorage.setItem(lastCmdKey, label); } catch(_){}
      showToast(`Derni√®re commande¬†: ${label}`);
    }

    function showToast(text){
      const toast = document.getElementById('toast');
      const tt = document.getElementById('toast-text');
      tt.textContent = text;
      toast.style.display = 'flex';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ toast.style.display='none'; }, 1600);
    }

    // Load persisted last command on startup
    (function(){
      try {
        const saved = localStorage.getItem(lastCmdKey);
        if(saved){ document.getElementById('last-command').textContent = saved; }
      } catch(_){ /* ignore */ }
    })();

    // --- Backend interaction (unchanged endpoint) --------------------------
    function sendAction(action){
      // small press animation comes from :active; extra haptic feel here
      fetch('/simulate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action })
      })
      .then(r => r.json())
      .then(data => {
        // Keep video feed; optionally overlay text feedback
        flashOverlay(action);
        setLastCommand(data.action || action);
        // Ne pas modifier l'√©tat moteur ici ("laisse tel quel")
      })
      .catch(err => {
        console.error('Erreur:', err);
        flashOverlay('Erreur');
      });
    }

    // Visual micro‚Äëfeedback on the screen
    function flashOverlay(action){
      const messages = {
        'avance': 'Avance‚Ä¶',
        'recule': 'Recule‚Ä¶',
        'tourne_a_gauche': 'Gauche‚Ä¶',
        'tourne_a_droite': 'Droite‚Ä¶',
        'klaxonne': 'BEEP! Klaxon',
        'clignotte': 'Clignotants',
        'Erreur': 'Erreur'
      };
      const scr = document.getElementById('screen');
      const tag = document.createElement('div');
      tag.style.position = 'absolute';
      tag.style.inset = '0';
      tag.style.display = 'grid';
      tag.style.placeItems = 'center';
      tag.style.pointerEvents = 'none';
      tag.style.borderRadius = '16px';
      tag.style.backdropFilter = 'blur(2px)';
      tag.style.background = 'rgba(0,0,0,.18)';
      tag.style.color = '#fff';
      tag.style.fontSize = '1.4rem';
      tag.textContent = messages[action] || action;
      scr.appendChild(tag);
      setTimeout(()=>{ tag.remove(); }, 500);
    }

    // Keyboard support for arrows
    window.addEventListener('keydown', (e)=>{
      if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
        e.preventDefault();
        const map = { ArrowUp:'avance', ArrowDown:'recule', ArrowLeft:'tourne_a_gauche', ArrowRight:'tourne_a_droite' };
        sendAction(map[e.key]);
      }
    });
  </script>
</body>
</html>
