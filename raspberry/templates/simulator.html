<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Simulateur Voiture – Mode manuel (capture panneau)</title>
  <style>
    :root{
      /* Layout sizing */
      --left-w: clamp(240px, 22vw, 320px);
      --right-w: clamp(280px, 26vw, 380px);
      --gap: 1.25rem;
      --header-h: 72px; /* recalculé au runtime */
      --screen-ratio: 16/9; /* ajusté au runtime selon le flux */

      /* Theme */
      --bg-dark:#f8fafc; --bg-light:#fff; --surface:#f1f5f9; --surface-light:#e2e8f0;
      --primary:#3b82f6; --primary-dark:#2563eb; --secondary:#8b5cf6; --accent:#06b6d4;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --text-primary:#0f172a; --text-secondary:#475569; --text-muted:#64748b; --border:rgba(15,23,42,.1);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg-dark);color:var(--text-primary);line-height:1.6;min-height:100dvh}

    /* Header */
    .header{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:1rem;padding:1rem 1.25rem;background:var(--bg-light);border-bottom:1px solid var(--border);box-shadow:0 4px 6px -1px rgba(0,0,0,.06)}
    .header-left{display:flex;align-items:center;gap:1rem}
    .logo{display:flex;align-items:center;gap:.75rem}
    .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:10px;display:grid;place-items:center;font-size:1.5rem}
    .header h1{font-size:1.15rem;font-weight:600;color:var(--text-primary);letter-spacing:-.02em}
    .center-brand{justify-self:center}
    .brand-logo{height:32px;width:auto}
    .header-right{display:flex;align-items:center;gap:.75rem;min-width:0}

    /* Tabs (web & mobile) */
    .nav-tabs,.nav-tabs-mobile{display:flex;gap:.5rem}
    .nav-tab{text-decoration:none;color:var(--text-secondary);padding:.5rem 1rem;border-radius:8px;transition:.2s;font-weight:500;font-size:.875rem;border:1px solid transparent}
    .nav-tab:hover{background:var(--surface);color:var(--text-primary)}
    .nav-tab.active{background:var(--primary);color:#fff;border-color:transparent}

    /* Main 3-col layout */
    main.layout{display:grid;grid-template-columns:var(--left-w) 1fr var(--right-w);gap:var(--gap);padding:var(--gap);height:calc(100dvh - var(--header-h));}
    .panel{background:var(--bg-light);border-radius:16px;border:1px solid var(--border);overflow:auto;min-height:0}
    #controlsPanel { overflow: hidden; }
    .panel.screen{ overflow: hidden; }

    /* Left info */
    .left{display:flex;flex-direction:column;gap:1rem;padding:1rem}
    .panel-header{display:flex;align-items:center;gap:.5rem;font-size:.875rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);padding-bottom:.75rem;border-bottom:1px solid var(--border)}
    .info{background:var(--surface);padding:1rem;border-radius:12px;border:1px solid var(--border);transition:.2s}
    .info:hover{border-color:var(--primary);transform:translateY(-1px)}
    .label{font-size:.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;font-weight:600}
    .value{font-size:1rem;font-weight:600;color:var(--text-primary);min-height:1.5em}
    #speed-limit{font-size:1.5rem;color:var(--success)}

    /* Screen center: maintain aspect + contain without crop */
    .screen{position:relative;background:#000;display:grid;place-items:center}
    .screen-inner{width:100%;height:100%;display:grid;place-items:center}
    .screen-frame{width:100%;height:100%;max-height:100%;aspect-ratio:var(--screen-ratio);display:grid;place-items:center}
    .screen img{max-width:100%;max-height:100%;width:100%;height:100%;object-fit:contain;display:block;background:#000}
    .screen-badge{position:absolute;top:1rem;left:1rem;background:rgba(59,130,246,.08);backdrop-filter:blur(6px);color:#e5edff;padding:.45rem .8rem;border-radius:10px;font-size:.82rem;font-weight:600;border:1px solid rgba(255,255,255,.15)}
    .screen-badge strong{color:#fff}

    /* Right controls */
    .right{display:flex;flex-direction:column;gap:1.25rem;padding:1rem}
    .quick-actions{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
    .quick{display:flex;flex-direction:column;align-items:center;gap:.35rem}
    .icon-btn{width:64px;height:64px;border-radius:12px;border:none;cursor:pointer;font-size:1.7rem;box-shadow:0 4px 12px rgba(0,0,0,.25);transition:.2s;display:grid;place-items:center;position:relative;overflow:hidden}
    .icon-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.12),transparent);opacity:0;transition:opacity .2s}
    .icon-btn:hover::before{opacity:1}
    .icon-btn:hover{transform:translateY(-2px)}
    .icon-btn:active{transform:translateY(0)}
    .icon-btn[disabled]{opacity:.5;cursor:not-allowed;transform:none!important}
    .icon-btn:nth-child(1){background:linear-gradient(135deg,#f59e0b,#d97706)}
    .icon-btn.secondary{background:linear-gradient(135deg,#8b5cf6,#7c3aed)}
    .icon-btn.tertiary{background:linear-gradient(135deg,#10b981,#059669)}

    .controller-section{display:flex;flex-direction:column;gap:.6rem}
    .controller-switch{display:flex;background:var(--surface);border-radius:12px;padding:4px;position:relative;border:1px solid var(--border)}
    .controller-pill{flex:1;z-index:2;border:none;background:transparent;padding:.7rem;border-radius:8px;cursor:pointer;font-weight:700;color:var(--text-secondary);transition:color .2s,font-variation-settings .2s;font-size:.9rem}
    .controller-pill[aria-pressed="true"]{color:var(--text-primary)}
    .controller-indicator{position:absolute;z-index:1;top:4px;bottom:4px;width:calc(50% - 4px);left:4px;border-radius:8px;background:var(--primary);box-shadow:0 6px 18px rgba(59,130,246,.35);transition:left .28s cubic-bezier(.4,0,.2,1)}
    .controller-switch.camera .controller-indicator{left:calc(50% + 0px)}
    .controller-hint{font-size:.78rem;color:var(--text-muted);text-align:center;line-height:1.4}

    .joystick-wrap{
      width: clamp(180px, 32vmin, 320px);
      aspect-ratio: 1;
      margin: 0 auto;
      position: relative;
    }

    .joystick{
      position: relative;
      width: 100%;
      height: auto;
      aspect-ratio: 1;
      display: grid;
      grid-template-columns: repeat(3,1fr);
      grid-template-rows: repeat(3,1fr);
      gap: clamp(8px, 1.5vmin, 14px);
      padding: clamp(10px, 2vmin, 16px);
      background: var(--surface);
      border-radius: 50%;
      box-shadow: inset 0 4px 12px rgba(0,0,0,.22);
      border: 1px solid var(--border);
    }

    /* Boutons carrés, qui ne s’étirent pas */
    .dpad-btn{
      width: 100%;
      height: 100%;
      aspect-ratio: 1;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: grid;
      place-items: center;
      box-shadow: 0 4px 12px rgba(59,130,246,.35);
      transition: transform .1s ease, border-color .1s ease, box-shadow .1s ease;
      border: 1px solid rgba(255,255,255,.12);
      /* bornes de taille pour rester confortables */
      max-width: clamp(44px, 7.5vmin, 72px);
      max-height: clamp(44px, 7.5vmin, 72px);
    }

    /* Placement sur la grille 3×3 */
    .dpad-up   { grid-column: 2; grid-row: 1; align-self: center; justify-self: center; }
    .dpad-left { grid-column: 1; grid-row: 2; align-self: center; justify-self: center; }
    .dpad-right{ grid-column: 3; grid-row: 2; align-self: center; justify-self: center; }
    .dpad-down { grid-column: 2; grid-row: 3; align-self: center; justify-self: center; }

    .hint{font-size:.78rem;color:var(--text-muted);text-align:center;margin-top:.35rem}
    .hint strong{color:var(--accent);font-weight:700}

    .toast{position:fixed;bottom:calc(1.2rem + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%);background:var(--bg-light);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;align-items:center;gap:.6rem;z-index:1000;backdrop-filter:blur(10px)}
    .flash{animation:pulse .8s ease}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.65)}100%{box-shadow:0 0 0 18px rgba(16,185,129,0)}}

    /* Admin/permissions bits (sync with chatbot.html) */
    .user-chip{display:flex;align-items:center;gap:.6rem;background:var(--bg-light);border:1px solid var(--border);border-radius:999px;padding:.35rem .5rem .35rem .35rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .user-avatar{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;font-size:.9rem}
    .user-name{font-weight:600;color:var(--text-primary);font-size:.9rem}
    .logout-form{margin:0}
    .logout-btn{border:1px solid var(--border);background:var(--surface);font-size:.8rem;padding:.25rem .55rem;border-radius:8px;cursor:pointer;color:var(--text-secondary);transition:background .15s,transform .1s}
    .logout-btn:hover{background:var(--surface-light)}
    .logout-btn:active{transform:translateY(1px)}
    .user-pill{display:inline-flex;align-items:center;gap:.5rem;padding:.2rem .55rem;border:1px solid var(--border);border-radius:999px;background:var(--surface)}
    .lock-btn{border:none;background:transparent;cursor:pointer;font-size:1rem;line-height:1}
    .lock-btn[disabled]{opacity:.5;cursor:not-allowed}
    .lock-on{color:var(--danger)} .lock-off{color:var(--success)}
    .controls-disabled .icon-btn,.controls-disabled .dpad-btn{opacity:.45;cursor:not-allowed}

    /* Responsiveness */
    @media (max-width: 1280px){
      main.layout{grid-template-columns:minmax(220px, var(--left-w)) 1fr minmax(260px, var(--right-w));}
    }
    @media (max-width: 1024px){
      main.layout{grid-template-columns:1fr;grid-template-rows:auto auto auto;height:auto}
      .screen{order:1}
      .right{order:2}
      .left{order:3;flex-direction:row;overflow-x:auto;padding:.75rem}
      .left .panel-header{display:none}
      .left .info{min-width:160px;flex-shrink:0}
      .joystick-wrap{ width: clamp(180px, 40vmin, 260px); }
      .dpad-btn{ max-width: clamp(44px, 8vmin, 64px); max-height: clamp(44px, 8vmin, 64px); }
    }
    @media (max-width: 768px){
      .brand-logo{height:24px}
      .header{
        grid-template-columns:1fr auto; grid-template-areas:
          "left right"
          "brand brand";
        row-gap:.5rem;
      }
      .header-left{grid-area:left}
      .center-brand{grid-area:brand; justify-self:center}
      .header-right{grid-area:right}
      .icon-btn{width:56px;height:56px;font-size:1.45rem}
      .screen-badge{font-size:.74rem}
      main.layout{padding:.75rem}
    }
    @media (orientation:landscape) and (max-height: 500px){
      /* Small laptop / landscape phones: prioritize screen height */
      .left,.right{padding:.75rem}
      .brand-logo{height:26px}
      .joystick-wrap{width:200px;height:200px}
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none!important;transition:none!important}
    }
  </style>
  <script>window.IS_ADMIN = {{ 'true' if is_admin else 'false' }};</script>
</head>
<body>
  <div class="header" id="appHeader">
    <div class="header-left">
      <div class="logo"><div class="logo-icon">🚗</div><h1>Drive Simulator Pro</h1></div>
    </div>
    <div class="center-brand"><img src="/static/logo.png" alt="Logo Drive Simulator Pro" class="brand-logo"></div>
    <div class="header-right">
      <!-- Onglets version desktop -->
      <nav class="nav-tabs" aria-label="Navigation principale (desktop)">
        <a class="nav-tab active" href="/">Simulateur</a>
        <a class="nav-tab" href="/chatbot">Chatbot</a>
      </nav>

      <div class="user-chip" title="Utilisateur connecté">
        <span class="user-avatar">{{ (user or '?')[:1]|upper }}</span>
        <span class="user-name">{{ user or 'Invité' }}</span>
        {% if is_admin %}
        <span class="user-badge" style="margin-left:.25rem;font-size:.75rem;color:#fff;background:linear-gradient(135deg,#f43f5e,#ec4899);padding:.15rem .45rem;border-radius:999px;font-weight:700;">ADMIN</span>
        {% endif %}
        <form class="logout-form" method="post" action="/logout"><button class="logout-btn" type="submit">Déconnexion</button></form>
      </div>
    </div>
  </div>

  <main class="layout" id="layoutRoot">
    <aside class="panel left">
      <div class="panel-header">📊 Informations</div>
      <section class="info"><div class="label">Vitesse Limite</div><div class="value" id="speed-limit">—</div></section>
      <section class="info"><div class="label">État du moteur</div><div class="value" id="engine-status">🟢 Arrêté</div></section>
      <section class="info"><div class="label">Dernière commande</div><div class="value" id="last-command">Aucune</div></section>
      <section class="info" aria-live="polite" aria-atomic="true"><div class="label">Description image</div><div class="value" id="img-desc">—</div></section>

      {% if is_admin %}
      <section class="info" id="admin-users">
        <div class="label">Utilisateurs connectés (autres)</div>
        <div class="value">
          <ul id="online-users" style="list-style:none;padding-left:0;margin:0;display:flex;flex-wrap:wrap;gap:.5rem;">
            <li style="color:var(--text-muted);">—</li>
          </ul>
        </div>
      </section>
      {% endif %}
    </aside>

    <section class="panel screen" id="screen">
      <div class="screen-inner">
        <div class="screen-frame">
          <img id="videoFeed" src="/video_feed" alt="Flux vidéo" />
        </div>
      </div>
      <div class="screen-badge">Mode détection: <strong>manuel</strong></div>
    </section>

    <aside class="panel right" id="controlsPanel">
      <div class="panel-header">🎮 Commandes</div>
      <div class="quick-actions" aria-label="Actions rapides">
        <div class="quick"><button class="icon-btn" id="btn-klax" title="Klaxonner" aria-label="Klaxonner" onclick="sendAction('klaxonne')">🔊</button><small>Klaxonner</small></div>
        <div class="quick"><button class="icon-btn secondary" id="btn-clig" title="Clignoter" aria-label="Clignoter" onclick="sendAction('clignotte')">🚨</button><small>Clignoter</small></div>
        <div class="quick"><button class="icon-btn tertiary" id="btn-capture" title="Prendre photo panneau" aria-label="Prendre photo panneau" onclick="captureSpeedSign()">📸</button><small>Photo panneau</small></div>
      </div>

      <div class="controller-section">
        <div id="controllerSwitch" class="controller-switch" role="tablist" aria-label="Sélecteur de manette">
          <div class="controller-indicator" aria-hidden="true"></div>
          <button id="pillVehicle" class="controller-pill" role="tab" aria-selected="true" aria-pressed="true" onclick="setController('vehicle')">🚗 Véhicule</button>
          <button id="pillCamera" class="controller-pill" role="tab" aria-selected="false" aria-pressed="false" onclick="setController('camera')">🎥 Caméra</button>
        </div>
        <div class="controller-hint" id="controllerHint">Flèches clavier = Véhicule · ZQSD = Caméra · 1/2 pour switcher</div>
      </div>

      <div class="joystick-wrap" aria-label="Manette directionnelle">
        <div class="joystick">
          <button class="dpad-btn dpad-up" id="btn-up" title="Avancer" aria-label="Avancer">⬆️</button>
          <button class="dpad-btn dpad-left" id="btn-left" title="Gauche" aria-label="Gauche">⬅️</button>
          <button class="dpad-btn dpad-right" id="btn-right" title="Droite" aria-label="Droite">➡️</button>
          <button class="dpad-btn dpad-down" id="btn-down" title="Reculer" aria-label="Reculer">⬇️</button>
        </div>
      </div>
      <p class="hint" id="permHint" style="display:none;">🔒 Contrôles désactivés par l’administrateur.</p>
      <p class="hint">Astuce : touche <strong>C</strong> = Photo panneau.</p>
    </aside>
  </main>

  <div class="toast" id="toast">✅ <span id="toast-text"></span></div>

  <script>
    // ---------- Layout sizing: make 100dvh reliable and account for header height
    function setHeaderHeightVar(){
      const h=document.getElementById('appHeader');
      if(!h) return;
      const hh=h.offsetHeight;
      document.documentElement.style.setProperty('--header-h', hh + 'px');
    }
    const setHeaderHeightVarDebounced = (()=>{let t;return ()=>{clearTimeout(t);t=setTimeout(setHeaderHeightVar,50)}})();
    window.addEventListener('load', setHeaderHeightVar);
    window.addEventListener('resize', setHeaderHeightVarDebounced);

    // ---------- Screen ratio: compute from image dimensions to avoid crop
    function applyScreenRatioFrom(img){
      if(!img || !img.naturalWidth || !img.naturalHeight) return;
      const ratio = img.naturalWidth / img.naturalHeight;
      if(isFinite(ratio) && ratio>0){
        document.documentElement.style.setProperty('--screen-ratio', ratio);
      }
    }
    const videoFeed = document.getElementById('videoFeed');
    if(videoFeed){
      if(videoFeed.complete){ applyScreenRatioFrom(videoFeed); }
      videoFeed.addEventListener('load', ()=>applyScreenRatioFrom(videoFeed));
    }

    // ---------- Toast
    function showToast(text,ok=true){
      const t=document.getElementById('toast'), tt=document.getElementById('toast-text');
      tt.textContent=text; t.style.display='flex';
      t.style.border=`1px solid ${ok?'rgba(16,185,129,.35)':'rgba(239,68,68,.35)'}`;
      clearTimeout(window.__toastTimer);
      window.__toastTimer=setTimeout(()=>{t.style.display='none';},1800);
    }

    // ---------- Last command + overlay
    const lastCmdKey='simu:last-command'; let currentController='vehicle';
    function setLastCommand(cmd){
      const map={'avance':'Avancer','recule':'Reculer','tourne_a_gauche':'Tourner à gauche','tourne_a_droite':'Tourner à droite','klaxonne':'Klaxonner','clignotte':'Clignoter','vitesse':'Évaluer Vitesse','performance':'Évaluer Performance','capture':'Capture panneau','cam_up':'Caméra ↑','cam_down':'Caméra ↓','cam_left':'Caméra ←','cam_right':'Caméra →'};
      const label=map[cmd]||cmd; document.getElementById('last-command').textContent=label;
      try{localStorage.setItem(lastCmdKey,label);}catch(_){}
      showToast(`Dernière commande : ${label}`);
    }
    (function(){try{const saved=localStorage.getItem(lastCmdKey); if(saved){document.getElementById('last-command').textContent=saved;}}catch(_){}})();

    function flashOverlay(action){
      const messages={'avance':'Avance…','recule':'Recule…','tourne_a_gauche':'Gauche…','tourne_a_droite':'Droite…','klaxonne':'BEEP! Klaxon','clignotte':'Clignotants','capture':'Capture…','cam_up':'Caméra ↑','cam_down':'Caméra ↓','cam_left':'Caméra ←','cam_right':'Caméra →','Erreur':'Erreur'};
      const scr=document.getElementById('screen'); const tag=document.createElement('div');
      tag.style.cssText='position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;border-radius:16px;backdrop-filter:blur(2px);background:rgba(0,0,0,.18);color:#fff;font-size:1.2rem';
      tag.textContent=messages[action]||action; scr.appendChild(tag); setTimeout(()=>tag.remove(),500);
    }

    // ---------- Controller switch
    function setController(type){
      currentController=(type==='camera')?'camera':'vehicle';
      const sw=document.getElementById('controllerSwitch');
      sw.classList.toggle('camera', currentController==='camera');
      document.getElementById('pillVehicle').setAttribute('aria-pressed', currentController==='vehicle');
      document.getElementById('pillCamera').setAttribute('aria-pressed', currentController==='camera');
      document.getElementById('pillVehicle').setAttribute('aria-selected', currentController==='vehicle');
      document.getElementById('pillCamera').setAttribute('aria-selected', currentController==='camera');
      updateDpadTitles();
      document.getElementById('controllerHint').textContent=(currentController==='vehicle')?'Flèches clavier = Véhicule · ZQSD = Caméra · 1/2 pour switcher':'ZQSD = Caméra · Flèches = Véhicule · 1/2 pour switcher';
    }
    function updateDpadTitles(){
      if(currentController==='vehicle'){
        document.getElementById('btn-up').title='Avancer'; document.getElementById('btn-down').title='Reculer';
        document.getElementById('btn-left').title='Tourner à gauche'; document.getElementById('btn-right').title='Tourner à droite';
      }else{
        document.getElementById('btn-up').title='Caméra haut'; document.getElementById('btn-down').title='Caméra bas';
        document.getElementById('btn-left').title='Caméra gauche'; document.getElementById('btn-right').title='Caméra droite';
      }
    }
    ['up','down','left','right'].forEach(dir=>{
      document.getElementById(`btn-${dir}`).addEventListener('click',()=>{ if(!window.__controlsAllowed) return;
        if(currentController==='vehicle'){const map={up:'avance',down:'recule',left:'tourne_a_gauche',right:'tourne_a_droite'}; sendAction(map[dir]);}
        else{const map={up:'cam_up',down:'cam_down',left:'cam_left',right:'cam_right'}; sendAction(map[dir]);}
      });
    });
    window.addEventListener('keydown',(e)=>{
      if(!window.__controlsAllowed){return;}
      if(e.key==='1'){setController('vehicle');}
      if(e.key==='2'){setController('camera');}
      if(e.key==='c'||e.key==='C'){captureSpeedSign();}
      if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){e.preventDefault(); const map={ArrowUp:'avance',ArrowDown:'recule',ArrowLeft:'tourne_a_gauche',ArrowRight:'tourne_a_droite'}; sendAction(map[e.key]);}
      const k=e.key.toLowerCase(); if(['z','q','s','d'].includes(k)){e.preventDefault(); const map={z:'cam_up',s:'cam_down',q:'cam_left',d:'cam_right'}; sendAction(map[k]);}
    });

    // ---------- Backend interactions
    function sendAction(action){
      if(!window.__controlsAllowed){return;}
      fetch('/simulate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action})})
      .then(r=>r.json()).then(d=>{flashOverlay(action); setLastCommand(d.action||action);})
      .catch(err=>{console.error('Erreur:',err); flashOverlay('Erreur');});
    }

    async function refreshSpeedLimit(){
      try{const r=await fetch('/speed_limit'); const j=await r.json(); const el=document.getElementById('speed-limit'); const v=j&&j.speed_limit;
        el.textContent=(v==null)?'—':(Number.isInteger(v)?`${v} km/h`:`${(+v).toFixed(1)} km/h`);
      }catch(_){}
    }
    refreshSpeedLimit(); setInterval(refreshSpeedLimit,1000);

    function setImageDescription(text){ document.getElementById('img-desc').textContent=text||'—'; }
    function limitToFiveWords(t){ if(!t) return '—'; return t.toString().trim().split(/\s+/).filter(Boolean).slice(0,5).join(' '); }
    async function describeImage(savedPath){
      if(!savedPath){ setImageDescription('—'); return; }
      setImageDescription('Analyse en cours…');
      try{const r=await fetch('/describe_image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:savedPath})});
        const j=await r.json(); const raw=(j&&(j.description||j.desc||j.text||''))+''; setImageDescription(limitToFiveWords(raw));
      }catch(e){console.error(e); setImageDescription('Erreur description');}
    }

    async function captureSpeedSign(){
      if(!window.__controlsAllowed){return;}
      const btn=document.getElementById('btn-capture'); if(btn.hasAttribute('disabled')) return;
      setLastCommand('capture'); flashOverlay('capture'); const original=btn.textContent; btn.setAttribute('disabled',''); btn.textContent='⏳';
      try{
        const r=await fetch('/capture_speed_sign',{method:'POST'}); const j=await r.json();
        if(!j.ok){ showToast(j.error?`Erreur capture: ${j.error}`:'Échec capture',false); setImageDescription('—'); return; }
        await refreshSpeedLimit();
        if(j.detected!=null){ const v=Number(j.detected); showToast(`Limite détectée: ${v} km/h`); highlightSpeedLimit(); }
        else{ showToast('Aucun nombre détecté', false); }
        if(j.saved_path){ await describeImage(j.saved_path); }
      }catch(e){console.error(e); showToast('Erreur réseau',false); setImageDescription('Erreur description');}
      finally{ btn.removeAttribute('disabled'); btn.textContent=original; }
    }
    function highlightSpeedLimit(){ const el=document.getElementById('speed-limit'); el.classList.add('flash'); setTimeout(()=>el.classList.remove('flash'),900); }

    // ---------- Permissions (front-only)
    window.__controlsAllowed = true;
    function applyPermissionState(allowed){
      window.__controlsAllowed = !!allowed;
      const hint = document.getElementById('permHint');
      ['btn-klax','btn-clig','btn-capture','btn-up','btn-down','btn-left','btn-right','pillVehicle','pillCamera'].forEach(id=>{
        const el = document.getElementById(id); if(!el) return;
        if(allowed){ el.removeAttribute('disabled'); } else { el.setAttribute('disabled',''); }
      });
      document.getElementById('layoutRoot').classList.toggle('controls-disabled', !allowed);
      hint.style.display = allowed ? 'none' : 'block';
    }
    async function pollMyPermission(){
      try{ const r = await fetch('/permissions/me'); if(!r.ok) throw 0;
        const j = await r.json(); applyPermissionState(!!j.allowed);
      }catch(_){ /* silencieux */ }
    }
    pollMyPermission(); setInterval(pollMyPermission, 3000);

    // ---------- Admin: users + lock buttons
    async function refreshOnlineUsers(){
      if (!window.IS_ADMIN) return;

      let j;
      try {
        const r = await fetch('/users/online');
        if(!r.ok) throw new Error('HTTP '+r.status);
        j = await r.json();
      } catch (e) {
        const ul = document.getElementById('online-users');
        if (ul) {
          ul.innerHTML = '';
          const li = document.createElement('li');
          li.style.color = 'var(--text-muted)';
          li.textContent = 'Impossible de charger les utilisateurs…';
          ul.appendChild(li);
        }
        return;
      }

      const ul = document.getElementById('online-users'); if(!ul) return;
      ul.innerHTML = '';

      const detailed = Array.isArray(j.users_detailed) ? j.users_detailed : [];
      const fallbackNames = Array.isArray(j.users) ? j.users : [];
      const list = detailed.length ? detailed : fallbackNames.map(n=>({name:n, page:'unknown'}));

      if(list.length===0){
        const li=document.createElement('li');
        li.style.color='var(--text-muted)';
        li.textContent='Personne d’autre en ligne';
        ul.appendChild(li);
        return;
      }

      for(const item of list){
        const pseudo = item.name || item;
        const page = (item.page || 'unknown');

        const li = document.createElement('li'); li.className='user-pill';
        const name = document.createElement('span'); name.textContent = pseudo;

        const badge = document.createElement('span');
        badge.className = 'page-badge ' + (page==='simulator'?'sim':(page==='chatbot'?'chat':'unknown'));
        badge.textContent = page==='simulator' ? '| Simulateur' : (page==='chatbot' ? '| Chatbot' : '| Inconnu');

        const btn  = document.createElement('button'); btn.className='lock-btn'; btn.setAttribute('aria-label','Basculer droit');
        btn.textContent = '🔓'; btn.classList.add('lock-off');

        try{
          const s = await fetch('/permissions/me?user='+encodeURIComponent(pseudo));
          if(s.ok){
            const sj = await s.json();
            const a = !!sj.allowed;
            btn.textContent = a?'🔓':'🔒';
            btn.classList.toggle('lock-off', a);
            btn.classList.toggle('lock-on', !a);
          }
        }catch(_){}

        btn.addEventListener('click', async ()=>{
          btn.disabled = true;
          try{
            const t = await fetch('/admin/permissions/toggle', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ user: pseudo })
            });
            const tj = await t.json();
            const a = !!tj.allowed;
            btn.textContent = a?'🔓':'🔒';
            btn.classList.toggle('lock-off', a);
            btn.classList.toggle('lock-on', !a);
          }catch(_){ }
          finally { btn.disabled = false; }
        });

        li.appendChild(name);
        li.appendChild(badge);
        li.appendChild(btn);
        ul.appendChild(li);
      }
    }
    if (window.IS_ADMIN){ refreshOnlineUsers(); setInterval(refreshOnlineUsers, 3000); }

    // Init
    setController('vehicle');

    // --- Heartbeat présence: indique que je suis sur le simulateur
    async function heartbeat(page){
      try{ await fetch('/presence', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ page })
      }); } catch(_){}
    }
    function startHeartbeat(page){
      heartbeat(page);
      window.__heartbeatTimer && clearInterval(window.__heartbeatTimer);
      window.__heartbeatTimer = setInterval(()=>heartbeat(page), 5000);
      document.addEventListener('visibilitychange', ()=>{
        if(document.visibilityState === 'visible'){ heartbeat(page); }
      });
    }
    startHeartbeat('simulator');
  </script>
</body>
</html>
