<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Chatbot - Drive Simulator Pro</title>
  <style>
    :root{
      --bg-dark:#f8fafc; --bg-light:#fff; --surface:#f1f5f9; --surface-light:#e2e8f0;
      --primary:#3b82f6; --primary-dark:#2563eb; --secondary:#8b5cf6; --accent:#06b6d4;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --text-primary:#0f172a; --text-secondary:#475569; --text-muted:#64748b; --border:rgba(15,23,42,.1)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg-dark);min-height:100vh;color:var(--text-primary);line-height:1.6;
    }

    /* ===== HEADER ===== */
    .header{
      display:grid; grid-template-columns:auto 1fr auto; align-items:center;
      gap:1rem; padding:.75rem 1rem; background:var(--bg-light);
      border-bottom:1px solid var(--border); box-shadow:0 4px 6px -1px rgba(0,0,0,.06);
      position:sticky; top:0; z-index:20;
    }
    .header-left{display:flex;align-items:center;gap:.75rem;min-width:0}
    .logo{display:flex;align-items:center;gap:.6rem;min-width:0}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:10px;display:grid;place-items:center;font-size:1.3rem;flex:0 0 36px}
    .header h1{font-size:1.05rem;font-weight:600;color:var(--text-primary);letter-spacing:-.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .center-brand{justify-self:center}
    .brand-logo{height:28px;width:auto;display:block}

    .header-right{display:flex;align-items:center;gap:.75rem;min-width:0}

    /* Onglets = mÃªme style que web */
    .nav-tabs{display:flex;gap:.5rem;align-items:center}
    .nav-tab{text-decoration:none;color:var(--text-secondary);padding:.5rem 1rem;border-radius:8px;transition:.2s;font-weight:500;font-size:.875rem;white-space:nowrap}
    .nav-tab:hover{background:var(--surface);color:var(--text-primary)}
    .nav-tab.active{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3)}

    /* Chip utilisateur */
    .user-chip{display:flex;align-items:center;gap:.6rem;background:var(--bg-light);border:1px solid var(--border);border-radius:999px;padding:.35rem .5rem .35rem .35rem;box-shadow:0 2px 8px rgba(0,0,0,.06);flex:0 0 auto}
    .user-avatar{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;font-size:.9rem}
    .user-name{font-weight:600;color:var(--text-primary);font-size:.9rem;max-width:12ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .logout-form{margin:0}
    .logout-btn{border:1px solid var(--border);background:var(--surface);font-size:.8rem;padding:.25rem .55rem;border-radius:8px;cursor:pointer;color:var(--text-secondary);transition:background .15s,transform .1s}
    .logout-btn:hover{background:var(--surface-light)} .logout-btn:active{transform:translateY(1px)}

    /* Badge page pour liste admin */
    .admin-card{background:var(--bg-light);border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:.75rem 1.25rem}
    .user-pill{display:inline-flex;align-items:center;gap:.5rem;padding:.2rem .55rem;border:1px solid var(--border);border-radius:999px;background:var(--surface)}
    .lock-btn{border:none;background:transparent;cursor:pointer;font-size:1rem;line-height:1}
    .lock-on{color:var(--danger)} .lock-off{color:var(--success)}
    .perm-hint{font-size:.8rem;color:var(--text-muted);margin-left:.5rem;display:none}
    .page-badge{
      font-size:.72rem;padding:.1rem .4rem;border-radius:999px;border:1px solid var(--border);
      background:var(--surface);color:var(--text-muted);
    }
    .page-badge.sim{ background:rgba(59,130,246,.08); color:#1e40af; border-color:rgba(59,130,246,.25);}
    .page-badge.chat{ background:rgba(16,185,129,.10); color:#065f46; border-color:rgba(16,185,129,.25);}
    .page-badge.unknown{ background:var(--surface); color:var(--text-muted); }

    /* ===== CHAT ===== */
    .chat-container{
      max-width:900px;margin:1rem auto;height:calc(100vh - 120px);
      display:flex;flex-direction:column;background:var(--bg-light);border-radius:16px;border:1px solid var(--border);
      box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden
    }
    .chat-header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:1.1rem;text-align:center;position:relative;border-bottom:1px solid var(--border)}
    .chat-header h2{font-weight:600;font-size:1.1rem;letter-spacing:-.02em}

    .chatbox{flex:1;padding:1.1rem;overflow-y:auto;background:var(--surface);display:flex;flex-direction:column;gap:.9rem}
    .chatbox::-webkit-scrollbar{width:8px}.chatbox::-webkit-scrollbar-track{background:transparent}.chatbox::-webkit-scrollbar-thumb{background:var(--surface-light);border-radius:10px}.chatbox::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

    .message{max-width:75%;padding:.9rem 1.1rem;border-radius:16px;font-size:.95rem;line-height:1.5;animation:fadeInUp .3s ease;word-wrap:break-word}
    .message.user{align-self:flex-end;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border-bottom-right-radius:6px;box-shadow:0 4px 12px rgba(59,130,246,.25)}
    .message.bot{align-self:flex-start;background:var(--bg-light);color:var(--text-primary);border:1px solid var(--border);border-bottom-left-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .message .meta{font-size:.75rem;opacity:.7;margin-top:.5rem;font-style:italic}

    .image-card{display:flex;flex-direction:column;gap:.75rem}
    .image-card img{width:100%;max-width:450px;border-radius:12px;border:1px solid var(--border);box-shadow:0 8px 20px rgba(0,0,0,.08);transition:transform .2s}
    .image-card img:hover{transform:scale(1.02)}

    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes typing{0%,80%,100%{transform:scale(.8);opacity:.5}40%{transform:scale(1);opacity:1}}
    .typing-indicator{display:none;align-self:flex-start;padding:1rem 1.25rem;background:var(--bg-light);border-radius:16px;border-bottom-left-radius:6px;border:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,.05);animation:fadeInUp .3s ease}
    .typing-dots{display:flex;gap:6px;align-items:center}
    .typing-dots span{width:8px;height:8px;border-radius:50%;background:var(--primary);animation:typing 1.4s infinite ease-in-out}
    .typing-dots span:nth-child(1){animation-delay:-.32s}.typing-dots span:nth-child(2){animation-delay:-.16s}

    .empty-state{text-align:center;color:var(--text-muted);font-size:.95rem;margin-top:2rem;padding:2rem;background:var(--bg-light);border-radius:12px;border:1px dashed var(--border)}

    .input-container{padding:.9rem 1rem;background:var(--bg-light);border-top:1px solid var(--border);display:flex;gap:.6rem;align-items:center}
    .input-message{flex:1;padding:1rem 1.1rem;border:2px solid var(--border);border-radius:12px;font-size:1rem;outline:none;transition:.2s;background:var(--surface);color:var(--text-primary);font-family:inherit}
    .input-message::placeholder{color:var(--text-muted)}
    .input-message:focus{border-color:var(--primary);background:#fff;box-shadow:0 0 0 3px rgba(59,130,246,.1);transform:scale(1.01)}
    .send-btn{padding:1rem 1.4rem;background:linear-gradient(135deg,var(--success),#059669);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:.2s;display:flex;align-items:center;gap:.5rem;font-size:.95rem;box-shadow:0 4px 12px rgba(16,185,129,.3)}
    .send-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(16,185,129,.4)}
    .send-btn:active{transform:translateY(0)}

    /* ====== MOBILE FIRST TWEAKS ====== */
    @media (max-width: 768px){
      .brand-logo{height:24px}
      .header{
        grid-template-columns:1fr auto; grid-template-areas:
          "left right"
          "brand brand";
        row-gap:.5rem;
      }
      .header-left{grid-area:left}
      .center-brand{grid-area:brand; justify-self:center}
      .header-right{grid-area:right}
      /* Onglets visibles AVANT le chip utilisateur */
      .nav-tabs{order:0; max-width:70vw; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none}
      .nav-tabs::-webkit-scrollbar{display:none}
      .nav-tab{padding:.45rem .8rem; font-size:.85rem}
      .user-chip{order:1}
      /* Hauteurs & rayons compacts */
      .chat-container{margin:.75rem;height:calc(100vh - 150px);border-radius:12px}
      .chat-header h2{font-size:1rem}
      .message{max-width:85%}
      .image-card img{max-width:100%}
      .input-container{padding:.75rem .9rem}
      .send-btn{padding:.85rem 1.15rem}
    }

    /* TrÃ¨s petits Ã©crans */
    @media (max-width: 420px){
      .header h1{display:none} /* Ã©vite le dÃ©calage du logo, on garde lâ€™icÃ´ne */
      .logo-icon{width:32px;height:32px;font-size:1.1rem}
      .brand-logo{height:22px}
      .user-name{max-width:9ch}
      .logout-btn{display:none} /* garde lâ€™essentiel visible */
      .chat-container{height:calc(100vh - 160px)}
    }
  </style>
  <script>window.IS_ADMIN = {{ 'true' if is_admin else 'false' }};</script>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">ðŸš—</div>
        <h1>Drive Simulator Pro</h1>
      </div>
    </div>

    <!-- Logo recentrÃ© sur mobile -->
    <div class="center-brand">
      <img src="/static/logo.png" alt="Logo Drive Simulator Pro" class="brand-logo">
    </div>

    <!-- Onglets AVANT le chip utilisateur sur mobile -->
    <div class="header-right">
      <nav class="nav-tabs" aria-label="Navigation principale">
        <a href="/" class="nav-tab">Simulateur</a>
        <a href="/chatbot" class="nav-tab active">Chatbot</a>
      </nav>
      <div class="user-chip" title="Utilisateur connectÃ©">
        <span class="user-avatar">{{ (user or '?')[:1]|upper }}</span>
        <span class="user-name">{{ user or 'InvitÃ©' }}</span>
        {% if is_admin %}
        <span class="user-badge" style="margin-left:.25rem;font-size:.75rem;color:#fff;background:linear-gradient(135deg,#f43f5e,#ec4899);padding:.15rem .45rem;border-radius:999px;font-weight:700;">ADMIN</span>
        {% endif %}
        <form class="logout-form" method="post" action="/logout"><button class="logout-btn" type="submit">DÃ©connexion</button></form>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <div class="chat-header"><h2>ðŸ’¬ Assistant de Conduite IA</h2></div>

    {% if is_admin %}
    <div id="adminViewerBar" style="display:none;padding:.6rem 1rem;border-bottom:1px solid var(--border);background:var(--surface);font-size:.9rem;">
      <strong>Vue admin</strong> â€” conversation de <span id="adminViewerUser" style="color:var(--primary)"></span>
      <button id="adminViewerClose" style="margin-left:1rem;border:1px solid var(--border);background:#fff;padding:.25rem .6rem;border-radius:8px;cursor:pointer;font-size:.85rem;">Quitter la vue</button>
      <span id="adminViewerLive" style="margin-left:.6rem;color:var(--text-muted)">(MAJ auto)</span>
    </div>
    {% endif %}

    {% if is_admin %}
    <div class="admin-card">
      <div style="font-size:.8rem;font-weight:700;text-transform:uppercase;color:var(--text-muted);letter-spacing:.05em;margin-bottom:.5rem;">
        Utilisateurs connectÃ©s (autres)
      </div>
      <ul id="online-users" style="list-style:none;padding-left:0;margin:0;display:flex;flex-wrap:wrap;gap:.5rem;">
        <li style="color:var(--text-muted);">â€”</li>
      </ul>
    </div>
    {% endif %}

    <div class="chatbox" id="chatbox">
      <div class="empty-state">ðŸ‘‹ Bonjour ! Je suis votre assistant de conduite virtuel.<br/>Dites par exemple : Â« Que vois-tu ? Â» pour capturer et dÃ©crire l'image. ðŸš—</div>
    </div>

    <div class="typing-indicator" id="typingIndicator"><div class="typing-dots"><span></span><span></span><span></span></div></div>

    <div class="input-container">
      <input id="inputMessage" class="input-message" placeholder="Tapez votre message ici..." maxlength="500" />
      <button class="send-btn" id="sendBtn" aria-label="Envoyer le message"><span>ðŸ“¨</span>Envoyer</button>
      <span id="permHintChat" class="perm-hint">ðŸ”’ Envoi dÃ©sactivÃ© par lâ€™admin</span>
    </div>
  </div>

  <script>
    const chatbox=document.getElementById('chatbox');
    const inputMessage=document.getElementById('inputMessage');
    const typingIndicator=document.getElementById('typingIndicator');
    const sendBtn=document.getElementById('sendBtn');
    const permHintChat=document.getElementById('permHintChat');
    let isFirstMessage=true;

    // --- Heartbeat prÃ©sence: indique que je suis sur le chatbot
    async function heartbeat(page){
      try{ await fetch('/presence', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ page })
      }); } catch(_){}
    }
    function startHeartbeat(page){
      heartbeat(page);
      window.__heartbeatTimer && clearInterval(window.__heartbeatTimer);
      window.__heartbeatTimer = setInterval(()=>heartbeat(page), 5000);
      document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'visible'){ heartbeat(page); }});
    }
    startHeartbeat('chatbot');

    inputMessage.addEventListener('keypress',e=>{ if(e.key==='Enter') sendMessage(); });
    sendBtn.addEventListener('click',sendMessage);

    function isImageCaptureIntent(text){
      const t=(text||'').toLowerCase().normalize('NFKD');
      const patterns=[/que vois[-\s]*tu\s*\??$/, /qu'?est-ce qui est (?:a|Ã ) l'?image\s*\??/, /qu'?y a[-\s]*t[-\s]*il (?:a|Ã ) l'?image\s*\??/, /prends?\s*(?:une\s*)?photo/, /capture\s*(?:l|la|une)?\s*image/, /qu'?est-ce que tu vois/i];
      return patterns.some(rx=>rx.test(t));
    }

    function addMessage(text,sender='bot'){
      if(isFirstMessage){ chatbox.innerHTML=''; isFirstMessage=false; }
      const div=document.createElement('div'); div.className=`message ${sender}`; div.textContent=text; chatbox.appendChild(div); chatbox.scrollTop=chatbox.scrollHeight; return div;
    }
    function addImageCard({src,alt,caption}){
      const wrap=document.createElement('div'); wrap.className='message bot';
      const card=document.createElement('div'); card.className='image-card';
      const img=document.createElement('img'); img.alt=alt||'Image capturÃ©e'; if(src) img.src=src;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=caption||'';
      card.appendChild(img); card.appendChild(meta); wrap.appendChild(card); chatbox.appendChild(wrap); chatbox.scrollTop=chatbox.scrollHeight; return {wrap,img,meta};
    }
    function showTyping(){ typingIndicator.style.display='block'; chatbox.scrollTop=chatbox.scrollHeight; }
    function hideTyping(){ typingIndicator.style.display='none'; }

    async function sendMessage(){
      const msg=(inputMessage.value||'').trim(); if(!msg) return;
      if(!window.__chatAllowed){ return; } // bloquÃ© par admin
      addMessage(msg,'user'); inputMessage.value='';
      if(isImageCaptureIntent(msg)){ showTyping(); try{ await captureAndDescribe(); }catch(err){ addMessage("DÃ©solÃ©, la capture d'image a Ã©chouÃ©.",'bot'); console.error(err);} finally{ hideTyping(); } return; }
      showTyping();
      try{
        const resp=await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
        const data=await resp.json(); addMessage(data.reply||'OK','bot');
      }catch(err){ addMessage("DÃ©solÃ©, une erreur s'est produite.",'bot'); console.error(err); }
      finally{ hideTyping(); }
    }

    async function captureAndDescribe(){
      const capResp=await fetch('/capture_speed_sign',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});
      const cap=await capResp.json(); if(!capResp.ok||!cap.ok){ throw new Error(cap.error||'Capture Ã©chouÃ©e'); }
      const fullPath=cap.full_path||cap.saved_path;
      const {img,meta}=addImageCard({src:fullPath?(`/snap?path=${encodeURIComponent(fullPath)}`):'',alt:'Image capturÃ©e',caption:'Image capturÃ©e â€” analyse en coursâ€¦'});
      const descResp=await fetch('/describe_image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:fullPath||cap.saved_path})});
      const desc=await descResp.json();
      if(!descResp.ok||!desc.ok){ meta.textContent="Ã‰chec de la description de l'image."; }
      else{ if(desc.data_url&&typeof desc.data_url==='string'){ img.src=desc.data_url; } meta.textContent=desc.description||'Description indisponible.'; }
    }

    inputMessage.addEventListener('focus',function(){ this.style.transform='scale(1.01)'; });
    inputMessage.addEventListener('blur',function(){ this.style.transform='scale(1)'; });

    // ------- Permissions (front) -------
    window.__chatAllowed = true;
    function applyChatPermission(allowed){
      window.__chatAllowed = !!allowed;
      if(allowed){ sendBtn.removeAttribute('disabled'); inputMessage.removeAttribute('disabled'); permHintChat.style.display='none'; }
      else{ sendBtn.setAttribute('disabled',''); inputMessage.setAttribute('disabled',''); permHintChat.style.display='inline-block'; }
    }
    async function pollMyPermission(){
      try{
        const r = await fetch('/permissions/me'); if(!r.ok) throw 0;
        const j = await r.json(); applyChatPermission(!!j.allowed);
      }catch(_){ /* silencieux */ }
    }
    pollMyPermission(); setInterval(pollMyPermission, 3000);

    // ------- Admin: liste + cadenas ----
    async function refreshOnlineUsers(){
      if (!window.IS_ADMIN) return;
      let j;
      try {
        const r = await fetch('/users/online');
        if(!r.ok) throw new Error('HTTP '+r.status);
        j = await r.json();
      } catch (e) {
        const ul = document.getElementById('online-users');
        if (ul) {
          ul.innerHTML = '';
          const li = document.createElement('li');
          li.style.color = 'var(--text-muted)';
          li.textContent = "Impossible de charger les utilisateursâ€¦";
          ul.appendChild(li);
        }
        return;
      }

      const ul = document.getElementById('online-users'); if(!ul) return;
      ul.innerHTML = '';

      const detailed = Array.isArray(j.users_detailed) ? j.users_detailed : [];
      const fallbackNames = Array.isArray(j.users) ? j.users : [];
      const list = detailed.length ? detailed : fallbackNames.map(n=>({name:n, page:'unknown'}));

      if (list.length === 0){
        const li=document.createElement('li');
        li.style.color='var(--text-muted)';
        li.textContent='Personne dâ€™autre en ligne';
        ul.appendChild(li);
        return;
      }

      for(const item of list){
        const pseudo = item.name || item;
        const page = item.page || 'unknown';

        const li=document.createElement('li'); li.className='user-pill';
        const name=document.createElement('span'); name.textContent=pseudo;

        const badge=document.createElement('span');
        badge.className='page-badge ' + (page==='simulator'?'sim':(page==='chatbot'?'chat':'unknown'));
        badge.textContent = page==='simulator' ? 'Simulateur' : (page==='chatbot' ? 'Chatbot' : 'Inconnu');

        const btn=document.createElement('button'); btn.className='lock-btn';
        btn.setAttribute('aria-label','Basculer droit'); btn.textContent='ðŸ”“'; btn.classList.add('lock-off');
        try{
          const s = await fetch('/permissions/me?user='+encodeURIComponent(pseudo));
          if(s.ok){
            const sj = await s.json();
            const a = !!sj.allowed;
            btn.textContent = a?'ðŸ”“':'ðŸ”’';
            btn.classList.toggle('lock-off', a);
            btn.classList.toggle('lock-on', !a);
          }
        }catch(_){}

        btn.addEventListener('click', async ()=>{
          btn.disabled = true;
          try{
            const t = await fetch('/admin/permissions/toggle', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ user: pseudo })
            });
            const tj = await t.json();
            const a = !!tj.allowed;
            btn.textContent = a?'ðŸ”“':'ðŸ”’';
            btn.classList.toggle('lock-off', a);
            btn.classList.toggle('lock-on', !a);
          }catch(_){ }
          finally { btn.disabled = false; }
        });

        // bouton ðŸ“œ pour ouvrir la vue des logs
        const logBtn = document.createElement('button');
        logBtn.className = 'lock-btn'; logBtn.setAttribute('title','Voir la conversation'); logBtn.textContent = 'ðŸ“œ';
        logBtn.addEventListener('click', ()=> openAdminLogView(pseudo));

        li.appendChild(name);
        li.appendChild(badge);
        li.appendChild(btn);
        li.appendChild(logBtn);
        ul.appendChild(li);
      }
    }
    if (window.IS_ADMIN){ refreshOnlineUsers(); setInterval(refreshOnlineUsers, 3000); }

    // ===== Admin: journaux (lecture seule) =====
    let __adminViewingUser = null;
    let __adminLogsTimer = null;

    function clearChat(){
      chatbox.innerHTML = '<div class="empty-state">â€”</div>';
      isFirstMessage = true;
    }

    function renderAdminLogs(user, logs){
      chatbox.innerHTML = '';
      isFirstMessage = false;
      if(!Array.isArray(logs) || logs.length === 0){
        const d=document.createElement('div');
        d.className='empty-state';
        d.textContent="Aucune conversation enregistrÃ©e.";
        chatbox.appendChild(d);
        return;
      }
      for(const m of logs){
        const who = (m.role==='user') ? 'user' : 'bot';
        const div = document.createElement('div');
        div.className = `message ${who}`;
        div.textContent = m.text || '';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${m.ts || ''} Â· ${m.role==='user' ? user : 'assistant'}`;
        div.appendChild(meta);
        chatbox.appendChild(div);
      }
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function fetchAdminLogsOnce(user){
      try{
        const r = await fetch('/admin/chatlogs?user=' + encodeURIComponent(user));
        if(!r.ok) return;
        const j = await r.json();
        if(!j.ok) return;
        renderAdminLogs(user, j.logs || []);
      }catch(_){}
    }

    function startAdminLogsLive(user){
      stopAdminLogsLive();
      __adminViewingUser = user;
      document.getElementById('adminViewerUser').textContent = user;
      document.getElementById('adminViewerBar').style.display = 'block';
      applyChatPermission(false); // lecture seule pendant la vue
      fetchAdminLogsOnce(user);
      __adminLogsTimer = setInterval(()=>fetchAdminLogsOnce(user), 3000);
    }
    function stopAdminLogsLive(){
      if(__adminLogsTimer){ clearInterval(__adminLogsTimer); __adminLogsTimer=null; }
      __adminViewingUser = null;
      document.getElementById('adminViewerBar').style.display = 'none';
      applyChatPermission(true); // rÃ©active lâ€™envoi
      clearChat();
    }
    function openAdminLogView(user){
      if(!window.IS_ADMIN) return;
      startAdminLogsLive(user);
    }
    const closeBtn = document.getElementById('adminViewerClose');
    if(closeBtn){ closeBtn.addEventListener('click', stopAdminLogsLive); }
  </script>
</body>
</html>
